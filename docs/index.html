<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orientación de calles en las principales ciudades del Perú</title>
    <link href="https://fonts.googleapis.com/css2?family=STIX+Two+Text:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-costa: #c7cb52;
            --color-sierra: #98692e;
            --color-selva: #62a162;
            --color-text: #2c3e50;
            --color-text-light: #7f8c8d;
            --color-bg: #ffffff;
            --color-bg-alt: #f8f9fa;
            --max-width: 1400px;
        }

        @import url('https://fonts.googleapis.com/css2?family=STIX+Two+Text:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap');

        body {
            font-family: 'STIX Two Text', 'Times New Roman', serif;
            line-height: 1.6;
            color: var(--color-text);
            background: var(--color-bg);
        }

        /* HERO SECTION */
        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(199, 203, 82, 0.05) 0%, rgba(152, 105, 46, 0.05) 50%, rgba(98, 161, 98, 0.05) 100%);
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--color-text);
            line-height: 1.2;
        }

        .hero p {
            font-size: 1.3rem;
            color: var(--color-text-light);
            max-width: 800px;
            margin-bottom: 2rem;
            line-height: 1.8;
            text-align: justify;
        }

        .hero a {
            color: var(--color-text);
            text-decoration: underline;
            font-weight: 500;
        }

        .hero a:hover {
            opacity: 0.8;
        }

        /* NARRATIVE SECTION */
        .narrative-section {
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding: 4rem 2rem;
            max-width: var(--max-width);
            margin: 0 auto;
            gap: 4rem;
        }

        .narrative-text {
            flex: 0 0 25%;
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--color-text-light);
        }

        /* Colores para palabras regionales */
        .word-costa {
            color: var(--color-costa);
            font-weight: 500;
        }

        .word-sierra {
            color: var(--color-sierra);
            font-weight: 500;
        }

        .word-selva {
            color: var(--color-selva);
            font-weight: 500;
        }

        /* MAIN CONTENT CONTAINER - Sin bordes de separación */
        .main-content-container {
            background: var(--color-bg);
        }

        /* COMPARATIVE CHART SECTION */
        #analisis-comparativo {
            background: var(--color-bg);
            border-top: none;
        }

        /* LIMA SECTION */
        #lima {
            background: var(--color-bg);
            border-top: none;
        }

        .comparative-chart {
            flex: 1 1 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .comparative-chart img {
            max-width: 100%;
            height: auto;
            object-fit: contain;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        .cities-showcase {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
        }

        /* Contenedor doble para Sierra y Selva */
        .dual-showcase {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
        }

        /* CITY SHOWCASE CARD - Estilo Ficha */
        .city-showcase {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 320px;
        }

        .city-showcase:hover {
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .showcase-header {
            padding: 1.25rem;
            border-bottom: 1px solid #e0e0e0;
            background: var(--color-bg-alt);
        }

        .showcase-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 0;
        }

        /* Grid layout: Mapa izquierda (grande), Polar y Stats derecha (stacked) */
        .showcase-content {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            grid-template-rows: auto auto;
            gap: 0;
            flex: 1;
            overflow: hidden;
        }

        .showcase-map {
            grid-column: 1;
            grid-row: 1 / 3;
            padding: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-alt);
            overflow: hidden;
        }

        .showcase-map img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .showcase-polar {
            grid-column: 2;
            grid-row: 1;
            padding: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-left: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .showcase-polar img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
        }

        .showcase-stats {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 1rem;
            background: white;
            border-left: 1px solid #e0e0e0;
            gap: 0.8rem;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            border-bottom: none;
            padding-bottom: 0;
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-light);
            font-weight: 700;
            flex: 0 1 auto;
        }

        .stat-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--color-text);
            text-align: right;
            flex: 0 0 auto;
            white-space: nowrap;
        }

        /* FILTER SECTION */
        .filter-section {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 4rem 2rem;
            background: var(--color-bg-alt);
            border-top: 2px solid #e0e0e0;
        }

        .filter-section h2 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 2rem;
            color: var(--color-text);
        }

        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select {
            padding: 0.75rem;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 1rem;
            color: var(--color-text);
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--color-text);
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
        }

        .filter-results {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1.5rem;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .filter-results::-webkit-scrollbar {
            width: 6px;
        }

        .filter-results::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .filter-results::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .filter-results::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .city-option {
            background: transparent;
            border: none;
            border-radius: 4px;
            padding: 0.6rem 0.8rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            user-select: none;
        }

        .city-option:hover {
            background: rgba(44, 62, 80, 0.05);
        }

        .city-option-checkbox {
            flex: 0 0 16px;
            width: 16px;
            height: 16px;
            border: 2px solid #d0d0d0;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            transition: all 0.2s ease;
        }

        .city-option.selected .city-option-checkbox {
            background: var(--color-text);
            border-color: var(--color-text);
        }

        .city-option.selected .city-option-checkbox::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .city-option-name {
            font-size: 0.95rem;
            font-weight: 400;
            color: var(--color-text);
            margin-bottom: 0;
            flex: 1;
        }

        .city-option.selected .city-option-name {
            font-weight: 500;
            color: var(--color-text);
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .download-btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            background: var(--color-text);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #1a252f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .download-btn:disabled {
            background: #bbb;
            cursor: not-allowed;
            transform: none;
        }

        .select-all-btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            background: #666;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .select-all-btn:hover {
            background: #555;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .clear-btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            background: #888;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background: #777;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* FOOTER */
        footer {
            background: var(--color-text);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
        }

        footer p {
            margin-bottom: 1rem;
        }

        footer a {
            color: #fff;
            text-decoration: underline;
            font-weight: 500;
        }

        footer a:hover {
            opacity: 0.8;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .footer-link-btn {
            display: inline-block;
            padding: 0.6rem 1.5rem;
            background: rgba(255,255,255,0.1);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.9rem;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }

        .footer-link-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .hero h1 { font-size: 2.5rem; }
            .hero p { font-size: 1.1rem; }
            .narrative-section {
                flex-direction: column;
                min-height: auto;
                padding: 2rem 1rem;
            }
            .narrative-text {
                flex: 0 0 auto;
            }
            .cities-showcase {
                order: -1;
            }
            
            /* Responsive showcase cards */
            .showcase-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .showcase-map {
                grid-column: 1;
                grid-row: 1;
                border-left: none;
                min-height: 200px;
            }
            
            .showcase-polar {
                grid-column: 1;
                grid-row: 2;
                border-left: none;
                border-bottom: 1px solid #e0e0e0;
                aspect-ratio: auto;
                min-height: 150px;
            }
            
            .showcase-stats {
                grid-column: 1;
                grid-row: 3;
                border-left: none;
            }
            
            #analisis-comparativo {
                flex-direction: column;
            }

            #analisis-comparativo .narrative-text {
                order: 1;
            }

            .comparative-chart {
                order: 0;
                padding: 1.5rem;
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            .filter-results {
                max-height: 300px;
            }
            .filter-actions {
                flex-direction: column;
                align-items: stretch;
            }
            .download-btn, .select-all-btn, .clear-btn {
                width: 100%;
            }
        }

        /* LOADING STATE */
        .loading {
            color: var(--color-text-light);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- HERO SECTION -->
    <section class="hero">
        <h1>Orientación de calles en las principales ciudades del Perú</h1>
        <p>
            ¿Les ha pasado que, habiendo crecido en una ciudad intermedia, tener que visitar Lima les supone un problema para orientarse en la ciudad?  
Los gráficos que verán a continuación representan la orientación de las calles en las tres ciudades más grandes de la costa, sierra y selva del Perú. En cada uno, la dirección de las barras indica su orientación, mientras que la longitud muestra qué tan frecuente es esa orientación en la ciudad. 
La revisión de estos patrones puede darnos luces sobre los procesos históricos del desarrollo de las ciudades, las culturas que allí se han asentado a lo largo del tiempo o las condiciones socioeconómicas locales que les han dado forma, pero también sobre cómo gestionarlas y planificarlas de cara al futuro. Por poner un ejemplo: ¿En donde creen que será más sencillo montar una red de transporte público eficiente? ¿En una ciudad con muchos o pocos cambios de dirección? 
        </p>
    </section>

    <!-- MAIN CONTENT CONTAINER - Todas las secciones sin separaciones -->
    <div class="main-content-container">
        <!-- COSTA SECTION -->
        <section id="costa" class="narrative-section region-costa">
            <div class="narrative-text">
                <p>
                    Mi primera impresión al ver la distribución de Trujillo es la de variedad. Muchas direcciones diferentes en distintas zonas. 
                    Sin embargo, al ver otras ciudades de la <span class="word-costa">costa</span> con un poco menos de población el panorama cambia. 
                    De hecho, en la mayoría de ciudades intermedias de esta zona del país los histogramas parecen mostrar una distribución más ordenada, menos heterogénea, de sus calles.
                </p>
            </div>
            <div class="cities-showcase" id="showcase-costa"></div>
        </section>

        <!-- SIERRA Y SELVA SECTION -->
        <section id="sierra-selva" class="narrative-section region-sierra">
            <div class="narrative-text">
                <p>
                    En las ciudades de la <span class="word-sierra">sierra</span> y de la <span class="word-selva">selva</span> paso algo parecido: cuando revisamos las ciudades más grandes el gráfico polar toma muchas direcciones, pero a medida que se revisan ciudades más pequeñas, las calles parecen estar más ordenadas. 
                    De hecho me llamó la atención lo ordenadas que son las calles en Cusco y Huancayo, ciudades que, por tener una topografía bastante más marcada que las de la <span class="word-costa">costa</span> habría esperado que muestren una distribución más variada. 
                    Por supuesto esto es una sobresimplificación producto de una revisión masiva, pero como primera aproximación me parece interesante.
                </p>
            </div>
            <div class="dual-showcase">
                <div class="cities-showcase" id="showcase-sierra"></div>
                <div class="cities-showcase" id="showcase-selva"></div>
            </div>
        </section>

        <!-- ANÁLISIS COMPARATIVO SECTION -->
        <section id="analisis-comparativo" class="narrative-section">
            <div class="narrative-text">
                <p>
                    De hecho, al revisar la relación entre cuánto varía la orientación de las calles con el área urbana de las ciudades, se puede ver claramente que hay una correlación positiva: a más tamaño, más diversa (y, por tanto, más "desordenada") es la red de calles. 
                </p>
            </div>
            <div class="comparative-chart">
                <img src="graficos/dispersion_4.png" alt="Análisis comparativo de orientación de calles">
            </div>
        </section>

        <!-- LIMA METROPOLITANA Y CALLAO SECTION -->
        <section id="lima" class="narrative-section">
            <div class="narrative-text">
                <p>
                    Y Lima metropolitana y Callao, la más grande y poblada del país, así lo demuestra.
                </p>
            </div>
            <div class="cities-showcase" id="showcase-lima"></div>
        </section>

        <!-- CLOSING TEXT SECTION -->
        <section class="hero closing-section">
            <p>
                El análisis está basado en el trabajo de <a href="https://appliednetsci.springeropen.com/articles/10.1007/s41109-019-0189-1" target="_blank">Boeing (2021)</a>. Para replicarlo, es necesario tener conocimientos básicos de Python; si es tu caso, puedes acceder al <a href="https://github.com/jose-rojasquiroz/orcalperu" target="_blank">repositorio</a> para clonarlo. Si no, puedes descargar encontrar las fichas de 92 ciudades del país en la siguiente sección.
            </p>
            <p>
                También puedes descargar el archivo vectorial de la red de calles y los polígonos urbanos de todas las ciudades peruanas dando clic <a href="https://github.com/jose-rojasquiroz/orcalperu/raw/refs/heads/main/docs/data/peru_sno.gpkg?download=" download>aquí</a>, que puedes abrir en cualquier programa de SIG.
            </p>
            <p>
                Para publicaciones que usen estos datos, por favor cítalos de la siguiente manera: "Rojas-Quiroz, J. (2024). Orientación de la red de calles de las principales ciudades del Perú (0.1.0). Zenodo. https://doi.org/10.5281/zenodo.13918305".
            </p>
        </section>
    </div>

    <!-- FILTER SECTION -->
    <section class="filter-section" id="filtros">
        <h2>Explora todas las ciudades</h2>
        <div class="filter-controls">
            <div class="filter-group">
                <label for="filter-region">Región natural</label>
                <select id="filter-region" onchange="updateFilters()">
                    <option value="">Todas</option>
                    <option value="Costa">Costa</option>
                    <option value="Sierra">Sierra</option>
                    <option value="Selva">Selva</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-department">Departamento</label>
                <select id="filter-department" onchange="updateFilters()">
                    <option value="">Todos</option>
                </select>
            </div>
        </div>
        <div class="filter-results" id="filter-results"></div>
        <div class="filter-actions">
            <button class="download-btn" id="download-selected-btn" onclick="downloadSelected()" disabled>
                Descargar fichas seleccionadas
            </button>
            <button class="select-all-btn" onclick="selectAll()">
                Seleccionar todos
            </button>
            <button class="clear-btn" onclick="clearSelection()">
                Limpiar selección
            </button>
        </div>
    </section>

    <!-- FOOTER -->
    <footer>
        <p>Elaborado por <a href="https://jose-rojasquiroz.github.io/" target="_blank">José Rojas-Quiroz</a></p>
        <p>Datos: INEI 2017, OpenStreetMap y OSMNx</p>
    </footer>

    <script>
        const DATA_PATH = 'data/';
        let allCities = [];
        let selectedCities = new Set();

        // Función para capitalizar correctamente nombres de ciudades
        function capitalizeFirstLetter(str) {
            if (!str) return '';
            
            // Caso especial: Lima Metropolitana se muestra como "Lima metropolitana y Callao"
            if (str.toUpperCase() === 'LIMA METROPOLITANA') {
                return 'Lima metropolitana y Callao';
            }
            
            // Palabras conectoras que no se capitalizan (excepto al inicio)
            const connectors = ['de', 'la', 'el', 'los', 'las', 'y', 'e', 'o', 'u', 'a'];
            
            // Dividir la cadena en palabras
            const words = str.toLowerCase().split(' ');
            
            // Capitalizar cada palabra según la regla
            const capitalized = words.map((word, index) => {
                // Primera palabra siempre se capitaliza
                if (index === 0) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
                // Si es un conector, no capitalizar
                if (connectors.includes(word)) {
                    return word;
                }
                // Resto de palabras: capitalizar
                return word.charAt(0).toUpperCase() + word.slice(1);
            });
            
            return capitalized.join(' ');
        }

        // Función para formatear números
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(0) + 'K';
            }
            return num.toString();
        }

        // Crear tarjeta de ciudad para showcase (estilo ficha)
        function createShowcaseCard(city) {
            const card = document.createElement('div');
            card.className = 'city-showcase';
            
            const cityNameFile = city.nombre.replace(/ /g, '_');
            const mapImg = `mapas/${cityNameFile}_mapa.png`;
            const polarImg = `graficos/${cityNameFile}_polar.png`;
            
            card.innerHTML = `
                <div class="showcase-header">
                    <div class="showcase-name">${capitalizeFirstLetter(city.nombre)}</div>
                </div>
                <div class="showcase-content">
                    <div class="showcase-map">
                        <img src="${mapImg}" alt="Mapa ${city.nombre}" 
                             onerror="this.alt='Mapa no disponible'">
                    </div>
                    <div class="showcase-polar">
                        <img src="${polarImg}" alt="Orientación ${city.nombre}" 
                             onerror="this.alt='Gráfico no disponible'">
                    </div>
                    <div class="showcase-stats">
                        <div class="stat-item">
                            <span class="stat-label">Población</span>
                            <span class="stat-value">${formatNumber(city.poblacion)}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Área urbana</span>
                            <span class="stat-value">${city.area_km2.toFixed(1)} km²</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Densidad</span>
                            <span class="stat-value">${Math.round(city.densidad)} hab/km²</span>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Cargar datos de una región para showcase
        async function loadShowcase(region) {
            const showcaseId = `showcase-${region}`;
            const container = document.getElementById(showcaseId);
            
            try {
                const response = await fetch(`${DATA_PATH}${region}_top3.json`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const cities = await response.json();
                container.innerHTML = '';
                cities.forEach(city => {
                    container.appendChild(createShowcaseCard(city));
                });
                
            } catch (error) {
                console.error(`Error cargando ${region}:`, error);
                container.innerHTML = `<div style="grid-column: 1/-1; color: #c33;">Error cargando datos</div>`;
            }
        }

        // Cargar una ciudad individual (para Lima metropolitana y Callao)
        async function loadIndividualCity(cityName, containerId) {
            const container = document.getElementById(containerId);
            
            try {
                const response = await fetch(`${DATA_PATH}ciudades.json`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const allCitiesData = await response.json();
                const city = allCitiesData.find(c => c.nombre.toUpperCase() === cityName.toUpperCase());
                
                if (!city) {
                    throw new Error(`Ciudad no encontrada: ${cityName}`);
                }
                
                container.innerHTML = '';
                container.appendChild(createShowcaseCard(city));
                
            } catch (error) {
                console.error(`Error cargando ${cityName}:`, error);
                container.innerHTML = `<div style="grid-column: 1/-1; color: #c33;">Error cargando datos</div>`;
            }
        }

        // Cargar todas las ciudades
        async function loadAllCities() {
            try {
                const response = await fetch(`${DATA_PATH}ciudades.json`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                allCities = await response.json();
                populateFilters();
                displayFilterResults();
                
            } catch (error) {
                console.error('Error cargando ciudades:', error);
            }
        }

        // Poblar filtros
        function populateFilters() {
            const departments = new Set();
            
            allCities.forEach(city => {
                if (city.departamento) departments.add(city.departamento);
            });
            
            const deptSelect = document.getElementById('filter-department');
            
            Array.from(departments).sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptSelect.appendChild(option);
            });
        }

        // Actualizar filtros
        function updateFilters() {
            displayFilterResults();
        }

        // Mostrar resultados de filtros
        function displayFilterResults() {
            const region = document.getElementById('filter-region').value;
            const department = document.getElementById('filter-department').value;
            
            const filtered = allCities.filter(city => {
                if (region && city.region !== region) return false;
                if (department && city.departamento !== department) return false;
                return true;
            });
            
            const resultsContainer = document.getElementById('filter-results');
            resultsContainer.innerHTML = '';
            
            filtered.forEach(city => {
                const option = document.createElement('div');
                option.className = 'city-option';
                if (selectedCities.has(city.nombre)) {
                    option.classList.add('selected');
                }
                
                option.innerHTML = `
                    <div class="city-option-checkbox"></div>
                    <div class="city-option-name">${capitalizeFirstLetter(city.nombre)}</div>
                `;
                
                option.onclick = () => toggleSelection(city.nombre, option);
                resultsContainer.appendChild(option);
            });
        }

        // Alternar selección
        function toggleSelection(cityName, element) {
            if (selectedCities.has(cityName)) {
                selectedCities.delete(cityName);
                element.classList.remove('selected');
            } else {
                selectedCities.add(cityName);
                element.classList.add('selected');
            }
            
            document.getElementById('download-selected-btn').disabled = selectedCities.size === 0;
        }

        // Descargar fichas seleccionadas
        function downloadSelected() {
            if (selectedCities.size === 0) return;
            
            selectedCities.forEach(cityName => {
                const link = document.createElement('a');
                link.href = `fichas/${cityName.replace(/ /g, '_')}_ficha.png`;
                link.download = `${cityName}_ficha.png`;
                link.click();
            });
        }

        // Limpiar selección
        function clearSelection() {
            selectedCities.clear();
            displayFilterResults();
            document.getElementById('download-selected-btn').disabled = true;
        }

        // Seleccionar todos
        function selectAll() {
            const region = document.getElementById('filter-region').value;
            const department = document.getElementById('filter-department').value;
            
            const filtered = allCities.filter(city => {
                if (region && city.region !== region) return false;
                if (department && city.departamento !== department) return false;
                return true;
            });
            
            filtered.forEach(city => {
                selectedCities.add(city.nombre);
            });
            
            displayFilterResults();
            document.getElementById('download-selected-btn').disabled = selectedCities.size === 0;
        }

        // Inicializar
        window.addEventListener('DOMContentLoaded', () => {
            loadShowcase('costa');
            loadShowcase('sierra');
            loadShowcase('selva');
            loadIndividualCity('LIMA METROPOLITANA', 'showcase-lima');
            loadAllCities();
        });
    </script>
</body>
</html>